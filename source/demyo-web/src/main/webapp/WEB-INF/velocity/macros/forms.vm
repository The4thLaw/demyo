#macro(form)
<form method="post" enctype="multipart/form-data" class="dem-model-form">
	$javascript.load("Demyo.Forms")
	$bodyContent
</form>
#end

#*
 * Redefinition of the springBind macro with less functionality but also compatibility with strict references.
 * Also sets an HTML id into fieldId based on the path
 *#
#macro(demyoBind $path)
	#set( $status = $springMacroRequestContext.getBindStatus($path) )
	#set( $fieldId = "field_${path.replaceAll('\.', '_')}" )
#end

#macro(inputHidden $path)
	#demyoBind($path)
	<input type="hidden" id="$fieldId" name="$status.expression" value="$!status.value" />
#end

#macro(formFieldOld $labelId $path)
	#if ($path != "")
		#demyoBind($path)
	#end
	<div class="field">
		<label for="$fieldId" class="dem-form__label">#_($labelId)</label>
		<div class="value">
			#set( $hasErrors = $!status.errorMessages && $status.errorMessages.size() > 0 )
			$bodyContent
			#if ($hasErrors)
				<span class="validation-error">$status.errorMessages[0]</a>
			#end
		</div>
	</div>
#end

#macro(formField $labelId $path)
	#if ($path != "")
		#demyoBind($path)
	#end
	#set( $hasErrors = $!status.errorMessages && $status.errorMessages.size() > 0 )
	## TODO: figure out how to preserve invalid status, which is removed by material on page load. Possibly, there is a callback after material has initialized, and we can re-add the class. Or perhaps a javascript snippet can run immediately to set the input to invalid
	<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label #if($hasErrors)is-invalid#end">
		$bodyContent
		<label class="mdl-textfield__label" for="$fieldId">#_($labelId)</label>
		#if ($hasErrors)
			<span class="mdl-textfield__error">$status.errorMessages[0]</span>
		#end
	</div>
#end

#macro(inputText $labelId $path)
	#@formField($labelId, $path)
		<input type="text" id="$fieldId" name="$status.expression" value="$!status.value" class="mdl-textfield__input" />
	#end
#end

#macro(inputMultilineText $labelId $path)
	#@formField($labelId, $path)
		<textarea id="$fieldId" name="$status.expression" rows="4" class="mdl-textfield__input plaintext #if($hasErrors)error#end">$!status.value</textarea>
	#end
#end

#macro(inputRichText $labelId $path)
	#@formFieldOld($labelId, $path)
		<textarea id="$fieldId" name="$status.expression" class="richtext #if($hasErrors)error#end">$!status.value</textarea>
	#end
	$javascript.load("TinyMCE")
#end

#macro(inputColour $labelId $path) 
	#@formFieldOld($labelId, $path)
		<input type="color" id="$fieldId" name="$status.expression" value="$!status.value"#if($hasErrors) class="error"#end />
		## TODO: use a polyfill for IE11
		
		<label class="dem-colour-remover mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="${fieldId}_colour_remover">
			<input type="checkbox" id="${fieldId}_colour_remover" class="mdl-checkbox__input" data-for="$fieldId" #if($!status.value)checked="checked"#end/>
			<span class="mdl-checkbox__label">#_('special.form.noColour')</span>
		</label>
	#end
#end

#macro(inputInteger $labelId $path)
	#@formField($labelId, $path)
		<input type="number" step="1" id="$fieldId" name="$status.expression" value="$!status.value" class="mdl-textfield__input integer" />
	#end
#end

#macro(inputFloat $labelId $path)
	#@formField($labelId, $path)
		<input type="number" step="any" id="$fieldId" name="$status.expression" value="$!status.value" class="mdl-textfield__input float" />
	#end
#end

#macro(inputDate $labelId $path)
	## TODO: polyfill if not supported
	#@formField($labelId, $path)
		<input type="date" id="$fieldId" name="$status.expression" value="$!status.value" class="mdl-textfield__input date" />
	#end
#end

#macro(inputCheckbox $labelId $path)
	#if ($path != "")
		#demyoBind($path)
	#end
	<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="$fieldId">
		<input type="checkbox" id="$fieldId" name="$status.expression" class="mdl-checkbox__input"#if ($!status.value == true) checked="checked"#end />
  		<span class="mdl-checkbox__label">#_("${labelId}.edit")</span>
	</label>
#end

## Options:
##		allowEmpty	Whether to let the user select no value (defaults to false)
#macro(inputSelect $labelId $path $values $options)
	#if(!$!options.allowEmpty)#set($dummy = $options.put("allowEmpty", false))#end

	#@formField($labelId, $path)
		<select id="$fieldId" name="$status.expression"#if($hasErrors) class="error"#end>
		#if ($options.allowEmpty)
			<option value=""></option>
		#end
		#foreach ($value in $values)
			<option value="$value.id"#if ($!status.value && $status.value == $value.id) selected="selected"#end>$value.identifyingName</option>
		#end
		</select>
	#end
#end

#macro(inputSelectMultiple $labelId $path $values)
	#@formField($labelId, $path)
		<select id="$fieldId" name="$status.expression" multiple="multiple"#if($hasErrors) class="error"#end>
		#foreach ($value in $values)
			#set ($selected = false)
			#if ($!status.value && !$hasErrors) ## When such a field has errors, the value is a String
				#foreach ($item in $status.value)
					#if ($item.id == $value.id)
						#set ($selected = true)
					#end
				#end
			#end
			<option value="$value.id"#if ($selected) selected="selected"#end>$value.identifyingName</option>
		#end
		</select>
	#end
#end

#macro(inputFile $labelId $path)
	#@formFieldOld($labelId, $path)
		<input type="file" id="$fieldId" name="$status.expression"#if($hasErrors) class="error"#end />
	#end
#end

#macro(formButtons $saveLabel $resetLabel)
	<div class="dem-form__buttons">
		<input type="submit" value="#_($saveLabel)" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent mdl-js-ripple-effect" />
		<input type="reset" value="#_($resetLabel)" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect" />
	</div>
#end

#macro(saveButtons)
	#formButtons('button.save', 'button.reset')
#end